!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.SpaazaReceipt=factory()}(this,function(){"use strict";const sumFieldValues=(arr,fieldName)=>(arr||[]).map(i=>i[fieldName]).reduce((s,v)=>s+v,0),sumFieldValuesConditional=(arr,fieldName,ifFieldName,isValue)=>(arr||[]).filter(i=>i[ifFieldName]===isValue).map(i=>i[fieldName]).reduce((s,v)=>s+v,0),parseReceipt=receipt=>{const{shopper:shopper,chain:chain}=receipt,{currency_symbol:currencySymbol,business:business}=chain;return{brand:{logoURL:chain.logo_url},details:{name:chain.id,id:receipt.id,total:receipt.total_value,date:receipt.timestamp,currencySymbol:currencySymbol},lineitems:{lineitems:receipt.line_items,currencySymbol:currencySymbol},linetaxes:{linetaxes:receipt.tax_lines,currencySymbol:currencySymbol},totals:{total:receipt.total_value,subtotal:receipt.subtotal,currencySymbol:currencySymbol},download:{downloadURL:receipt.download_url},wallet:{wallet:receipt.monetary_wallet,totalEarned:sumFieldValues(receipt.monetary_wallet.contributions,"amount"),totalSpent:sumFieldValuesConditional(receipt.basket_vouchers,"amount","type","wallet"),currencySymbol:currencySymbol},pointswallet:{wallet:receipt.points_wallet||{},totalEarned:receipt.points_wallet&&sumFieldValues(receipt.points_wallet.contributions,"amount")||0,totalSpent:0,currencySymbol:"pts"},store:{name:business.name,contact:business.phone_number,email:business.email,website:business.website_url,address:`${business.address.address_1} ${business.address.address_2} ${business.address.address_3}`.trim(),postalcode:business.address.postal_code,towncity:business.address.towncity},barcode:{retailerCode:receipt.retailer_basket_code||""}}};const stringData={"en-GB":{langCode:"en-GB",brand:{title:"Your Receipt",message:"Hi there $GIVEN_NAME, thanks for your purchase!"},details:{message:"Your order details from $CHAIN_NAME:",charged:"CHARGED","order-number":"Order number",date:"Date"},lineitems:{name:"Name",quantity:"Qty",price:"Price"},linetaxes:{"tax-rate":"VAT Rate","order-value":"Order value","tax-value":"VAT"},totals:{subtotal:"Subtotal",total:"Total"},wallet:{earned:"earned",spent:"spent","new-balance":"Your new balance"},download:{label:"Download your PDF Receipt"},store:{message:"Thank you!"},error:{message:"There was a problem showing this receipt."}},"nl-NL":{langCode:"nl-NL",brand:{title:"Jouw Bon",message:"Bedankt voor je aankoop, $GIVEN_NAME!"},details:{message:"Informatie over je aankoop bij $CHAIN_NAME:",charged:"In rekening gebracht","order-number":"Bestellingsnummer",date:"Datum"},lineitems:{name:"Naam",quantity:"Aantal",price:"Prijs"},linetaxes:{"tax-rate":"BTW %","order-value":"Waarde","tax-value":"BTW"},totals:{subtotal:"Subtotaal",total:"Totaal"},wallet:{earned:"verdiend",spent:"uitgegeven","new-balance":"Jouw nieuwe totaal"},download:{label:"Download je bon als PDF"},store:{message:"Hartelijk bedankt!"},error:{message:"Er was een probleem met het tonen van deze bon."}}},mapLangCode=lang=>{let lc="en-GB";return"nl"!==(lang=lang.toLowerCase().trim())&&"nl-"!==lang.substr(0,3)&&"nl_"!==lang.substr(0,3)||(lc="nl-NL"),lc},getStrings=lang=>stringData[mapLangCode(lang)],transformBlock=(block,fn)=>{const res={};for(const k in block)block.hasOwnProperty(k)&&(res[k]=fn(block[k],k));return res},transformStringBlocks=(strings,blkFn)=>{const res={};for(const section in strings)strings.hasOwnProperty(section)&&"object"==typeof strings[section]&&(res[section]=blkFn(strings[section],section));return res},transformStrings=(strings,fn)=>transformStringBlocks(strings,(blk,_section)=>transformBlock(blk,fn)),substitute=(str,subst)=>{let result=str;for(const k in subst)subst.hasOwnProperty(k)&&(result=result.replace(new RegExp((text=>text.replace(/[\-\[\]\{\}\(\)\*\+\?\.\\\^\$\|\#]/g,s=>`\\${s}`))(k),"g"),subst[k]));return result},applySubstitutions=(strings,subst)=>transformStrings(strings,s=>substitute(s,subst)),overrideStrings=(strings,overrides)=>transformStringBlocks(strings,(source,section)=>{const sectOver=overrides[section];return transformBlock(source,(srcStr,key)=>sectOver&&key in sectOver?sectOver[key]:srcStr)}),amount=(value,currencySymbol)=>{const isPoints="pts"===currencySymbol,symbolInFront=!isPoints,fmtValue=(+value).toFixed(isPoints?0:2);return symbolInFront?`${currencySymbol} ${fmtValue}`:`${fmtValue} ${currencySymbol}`},entities=val=>(val||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/%u/g,"&#x"),divider=`\n<table class="divider-wrapper">\n\t<tr>\n\t\t<td class="divider-spacer">\n\t\t<table class="divider" cellpadding="0" cellspacing="0">\n\t\t\t<tr><td></td></tr>\n\t\t</table>\n\t\t</td>\n\t</tr>\n</table>\n`,Brand=(data,strings,langCode)=>{let html=`<table>`;return data.logoURL&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td><img class="brand_logo" src="${entities(data.logoURL)}"></td>\n\t\t\t</tr>\n\t\t`),strings.title&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td><h1>${strings.title}</h1></td>\n\t\t\t</tr>\n\t\t`),strings.message&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td><p>${strings.message}</p></td>\n\t\t\t</tr>\n\t\t`),html+=`</table>`},Details=(data,strings,langCode)=>{let html=`<table>`;return strings.message&&(html+=`<tr><td colspan="2">${strings.message}</td></tr>`),data.total&&(html+=`\n\t\t\t<tr class="receipt-strong">\n\t\t\t\t<td class="">${strings.charged}</td>\n\t\t\t\t<td class="align-right">${amount(data.total,data.currencySymbol)}</td>\n\t\t\t</tr>\n\t\t`),data.id&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td class="">${strings["order-number"]}</td>\n\t\t\t\t<td class="align-right">#${entities(data.id)}</td>\n\t\t\t</tr>\n\t\t`),data.date&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td class="">${strings.date}</td>\n\t\t\t\t<td class="align-right">${entities(new Date(data.date).toLocaleString(langCode))}</td>\n\t\t\t</tr>\n\t\t`),html+=`</table>`},LineItems=(data,strings,langCode)=>{if(!data.lineitems||!data.lineitems.length)return"";const currencySymbol=data.currencySymbol;let html="";html+=divider,html+=`\n\t\t<table class="receipt-lineitems">\n\t\t\t<tr>\n\t\t\t\t<th class="align-left">${strings.name}</th>\n\t\t\t\t<th class="align-center">${strings.quantity}</th>\n\t\t\t\t<th class="align-right">${strings.price}</th>\n\t\t\t</tr>\n\t`;for(const item of data.lineitems){const isOnSale=item.original_price>item.sale_price;html+=`\n\t\t\t<tr class="line-item">\n\t\t\t\t<td class="align-left">\n\t\t\t\t\t<div class="line-item-name">${entities(item.name||item.barcode)}</div>\n\t\t\t\t</td>\n\t\t\t\t<td class="align-center">${entities(item.quantity)}</td>\n\t\t\t\t<td class="align-right">\n\t\t\t\t\t<span class="receipt-original-price ${isOnSale?"receipt-line-through":""}">${amount(item.original_price,currencySymbol)}</span>\n\t\t\t\t\t<span class="receipt-sale-price receipt-strong">${amount(item.sale_price,currencySymbol)}</span>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`}return html+=`</table>`},LineTaxes=(data,strings,langCode)=>{if(!data.linetaxes||!data.linetaxes.length)return"";const currencySymbol=data.currencySymbol;let html="";html+=divider,html+=`\n\t\t<table class="receipt-linetaxes">\n\t\t\t<tr>\n\t\t\t\t<th class="align-left">${strings["tax-rate"]}</th>\n\t\t\t\t<th class="align-center">${strings["order-value"]}</th>\n\t\t\t\t<th class="align-right">${strings["tax-value"]}</th>\n\t\t\t</tr>\n\t`;for(const tax of data.linetaxes)html+=`\n\t\t\t<tr class="tax-line">\n\t\t\t\t<td class="var-rate align-left">${entities(tax.rate)}%</td>\n\t\t\t\t<td class="order-value align-center">${amount(tax.order_value,currencySymbol)}</td>\n\t\t\t\t<td class="vat align-right">${amount(tax.tax_value,currencySymbol)}</td>\n\t\t\t</tr>\n\t\t`;return html+=`</table>`},Totals=(data,strings,langCode)=>{let html="";return html+=divider,html+=`<table class="receipt-totals">`,html+=`\n\t\t<tr class="receipt-subtotal">\n\t\t\t<td>${strings.subtotal}</td>\n\t\t\t<td class="align-right">${amount(data.subtotal,data.currencySymbol)}</td>\n\t\t</tr>\n\t`,html+=`\n\t\t<tr class="receipt-strong">\n\t\t\t<td>${strings.total}</td>\n\t\t\t<td class="align-right">${amount(data.total,data.currencySymbol)}</td>\n\t\t</tr>\n\t`,html+=`</table>`},Wallet=(data,strings,langCode)=>{const{wallet:wallet,totalEarned:totalEarned,totalSpent:totalSpent,currencySymbol:currencySymbol}=data;if(!totalEarned&&!totalSpent)return"";let html="";if(html+=divider,html+=`<table class="receipt-wallet">`,html+=`<tr><td class="receipt-strong">${entities(wallet.title)}</td></tr>`,totalEarned&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td>${entities(wallet.title)} ${strings.earned}</td>\n\t\t\t\t<td align="right">${amount(totalEarned,currencySymbol)}</td>\n\t\t\t</tr>\n\t\t`,wallet.contributions.length>1))for(const contrib of wallet.contributions)html+=`\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>&nbsp;&nbsp;&nbsp;&nbsp;${entities(contrib.campaign_title)}</td>\n\t\t\t\t\t\t<td align="right">${amount(contrib.amount,currencySymbol)}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t`;return totalSpent&&(html+=`\n\t\t\t<tr>\n\t\t\t\t<td>${entities(wallet.title)} ${strings.spent}</td>\n\t\t\t\t<td align="right">${amount(totalSpent,currencySymbol)}</td>\n\t\t\t</tr>\n\t\t`),html+=`\n\t\t<tr class="receipt-total">\n\t\t\t<td>${strings["new-balance"]}</td>\n\t\t\t<td align="right" class="receipt-strong">${amount(wallet.total,currencySymbol)}</td>\n\t\t</tr>\n\t`,html+=`</table>`},Download=(data,strings,langCode)=>{let html="";return data.downloadURL&&(html+=divider,html+=`<div class="btn-download"><a href="${entities(data.downloadURL)}" target="_blank">${strings.label}</a><div>`),html},Store=(data,strings,langCode)=>{if(!(data.name||data.message||data.address||data.contact||data.email||data.website||data.towncity||data.postalcode))return"";let html="";return html+=divider,html+=`<table class="receipt-store">`,html+=`\n\t\t<tr>\n\t\t\t<td class="align-left">\n\t`,data.name&&(html+=`<div>${entities(data.name)}</div>`),data.email&&(html+=`<div><a href="mailto:${entities(data.email)}">${entities(data.email)}</a></div>`),data.website&&(html+=`<div><a href="${entities(data.website)}" target="_blank">${entities(data.website)}</a></div>`),html+=`\n\t\t</td>\n\t\t<td class="align-right">\n\t`,data.contact&&(html+=`<a href="tel:${entities(data.contact)}">${entities(data.contact)}</a>`),data.address&&(html+=`<div>${entities(data.address)}</div>`),data.towncity&&data.postalcode?html+=`<div>${entities(data.towncity)}, ${entities(data.postalcode)}</div>`:data.towncity&&!data.postalcode?html+=`<div>${entities(data.towncity)}</div>`:!data.towncity&&data.postalcode&&(html+=`<div>${entities(data.postalcode)}</div>`),html+=`\n\t\t\t</td>\n\t\t</tr>\n\t`,html+=`</table>`,strings.message&&(html+=divider,html+=`<p class="receipt-emphasys receipt-footer-message">${strings.message}</p>`),html},BarCode=(data,strings,langCode)=>data.retailerCode?`\n\t\t<div class="content barcode">\n\t\t\t<div class="image" title="Barcode: ${data.retailerCode}" style="background-image: url(https://missetam.spaaza.com/barcode/${data.retailerCode})"></div>\n\t\t</div>\n\t`:``,Receipt$2=(data,strings,langCode)=>{const layout={header:["brand","details"],content:["lineitems","linetaxes","totals","wallet","pointswallet","download"],footer:["store","barcode"]},components={brand:Brand,details:Details,lineitems:LineItems,linetaxes:LineTaxes,totals:Totals,wallet:Wallet,download:Download,store:Store,barcode:BarCode};let result=`<div class="main content">`;for(const section in layout){result+=`<section>`;for(const componentName of layout[section]){const component="pointswallet"===componentName?components.wallet:components[componentName],compStrings="pointswallet"===componentName?strings.wallet:strings[componentName];result+=component(data[componentName],compStrings,langCode)}result+=`</section>`}return result+=`</div>`},Error=(data,strings,langCode)=>`\n\t\t<div class="main content">\n\t\t\t<p>${strings.message}</p>\n\t\t</div>\n\t`;class Receipt extends HTMLElement{static get observedAttributes(){return["language","redraw"]}constructor(){super(),this.root=this.attachShadow({mode:"open"}),this.connected=!1}connect(){this.redraw(),this.connected=!0}connectedCallback(){document.addEventListener("readystatechange",()=>{"loading"!==document.readyState&&this.connect()})}attributeChangedCallback(attr,oldVal,newVal){this.connected&&this.redraw()}getConfig(){const getJSONBlock=type=>{const dataNode=this.root.host.querySelector(`script[data-${type}]`);if(dataNode&&dataNode.textContent)try{return JSON.parse(dataNode.textContent)}catch(err){console.warn(`Failed to parse ${type} data: `,err)}},lang=this.root.host.getAttribute("language")||"",langStrings=getStrings(lang),userStrings=getJSONBlock("strings"),combinedStrings=userStrings?overrideStrings(langStrings,userStrings):langStrings;return{langCode:langStrings.langCode,receipt:getJSONBlock("receipt"),strings:combinedStrings}}redraw(){const config=this.getConfig();let contents;if(config.receipt){const data=parseReceipt(config.receipt),substituted=applySubstitutions(config.strings,{$GIVEN_NAME:config.receipt.shopper.first_name,$FAMILY_NAME:config.receipt.shopper.last_name,$CHAIN_NAME:config.receipt.chain.name}),finalStrings=transformStrings(substituted,s=>entities(s));contents=Receipt$2(data,finalStrings,config.langCode)}else console.warn("Could not draw receipt",config),contents=Error(0,config.strings.error,config.langCode);this.root.innerHTML=`<style>.spaaza-receipt a,.spaaza-receipt div,.spaaza-receipt table,.spaaza-receipt td{box-sizing:border-box}.spaaza-receipt img{-ms-interpolation-mode:bicubic;max-width:100%}.spaaza-receipt :host{display:block;font-family:"Helvetica Neue",Helvetica,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;height:100%!important;line-height:1.6em;margin:0;padding:0;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;width:100%!important}.spaaza-receipt table{border-collapse:separate!important;mso-table-lspace:0;mso-table-rspace:0;width:100%}.spaaza-receipt table td,.spaaza-receipt table th{font-family:"Helvetica Neue",Helvetica,Arial,"Lucida Grande",sans-serif;font-size:14px;vertical-align:top}.spaaza-receipt table th{font-size:12px;text-transform:uppercase;font-weight:400;color:#aaa}.spaaza-receipt .ExternalClass{width:100%}.spaaza-receipt .ExternalClass,.spaaza-receipt .ExternalClass div,.spaaza-receipt .ExternalClass font,.spaaza-receipt .ExternalClass p,.spaaza-receipt .ExternalClass span,.spaaza-receipt .ExternalClass td{line-height:100%}.spaaza-receipt body{background-color:#f6f6f6}.spaaza-receipt .body{background-color:#f6f6f6;width:100%}.spaaza-receipt .container{display:block;Margin:0 auto!important;max-width:580px;padding:10px;width:auto!important;width:580px}.spaaza-receipt .content{display:block;margin:0 auto;max-width:580px;padding:10px}.spaaza-receipt .main{background:#fff;border:1px solid #e9e9e9;border-radius:3px;width:100%;padding:2em}.spaaza-receipt .wrapper{padding:30px}.spaaza-receipt .content-block{padding:0 0 30px}.spaaza-receipt .header{margin-bottom:30px;margin-top:20px;width:100%}.spaaza-receipt .footer{clear:both;width:100%}.spaaza-receipt .footer *{color:#999;font-size:12px}.spaaza-receipt .footer td{padding:20px 0}.spaaza-receipt h1,.spaaza-receipt h2,.spaaza-receipt h3,.spaaza-receipt h4{color:#111!important;font-family:"Helvetica Neue",Helvetica,Arial,"Lucida Grande",sans-serif;font-weight:400;line-height:1.4em;margin:0;margin-bottom:30px}.spaaza-receipt h1{font-size:38px;text-transform:capitalize;font-weight:300}.spaaza-receipt h2{font-size:24px}.spaaza-receipt h3{font-size:18px}.spaaza-receipt h4{font-size:14px;font-weight:500}.spaaza-receipt ol,.spaaza-receipt p,.spaaza-receipt ul{font-family:"Helvetica Neue",Helvetica,Arial,"Lucida Grande",sans-serif;font-size:14px;font-weight:400;margin:0;margin-bottom:15px}.spaaza-receipt ol li,.spaaza-receipt p li,.spaaza-receipt ul li{list-style-position:inside;margin-left:5px}.spaaza-receipt a{color:#348eda;text-decoration:underline}.spaaza-receipt .word-wrap,.spaaza-receipt code,.spaaza-receipt pre{word-break:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;hyphens:auto}.spaaza-receipt .divider{border-collapse:separate}.spaaza-receipt .divider-spacer{padding:20px 0}.spaaza-receipt .divider td{border-top:1px solid #ccc;line-height:0;font-size:0;height:1px;margin:0;padding:0}.spaaza-receipt .last{margin-bottom:0}.spaaza-receipt .first{margin-top:0}.spaaza-receipt .align-center{text-align:center}.spaaza-receipt .align-right{text-align:right}.spaaza-receipt .align-left{text-align:left}.spaaza-receipt .clear{clear:both}.spaaza-receipt .mt0{margin-top:0}.spaaza-receipt .mb0{margin-bottom:0}.spaaza-receipt .preheader{color:transparent;display:none;height:0;max-height:0;max-width:0;opacity:0;overflow:hidden;mso-hide:all;visibility:hidden;width:0}@media only screen and (max-width:620px){.spaaza-receipt table[class=body] h1,.spaaza-receipt table[class=body] h2,.spaaza-receipt table[class=body] h3,.spaaza-receipt table[class=body] h4{font-weight:600!important}.spaaza-receipt table[class=body] h1{font-size:22px!important}.spaaza-receipt table[class=body] h2{font-size:18px!important}.spaaza-receipt table[class=body] h3{font-size:16px!important}.spaaza-receipt table[class=body] .content,.spaaza-receipt table[class=body] .wrapper{padding:10px!important}.spaaza-receipt table[class=body] .container{padding:0!important;width:100%!important}.spaaza-receipt table[class=body] .btn a,.spaaza-receipt table[class=body] .btn table{width:100%!important}}.spaaza-receipt .receipt-strong{font-weight:700;text-transform:uppercase}.spaaza-receipt .receipt-emphasys{font-style:italic}.spaaza-receipt .receipt-line-through{text-decoration:line-through}.spaaza-receipt table.receipt-lineitems td,.spaaza-receipt table.receipt-lineitems th,.spaaza-receipt table.receipt-linetaxes td,.spaaza-receipt table.receipt-linetaxes th{width:33%}.spaaza-receipt img.brand{display:block;margin:3em auto;height:100px}.spaaza-receipt h1{text-align:center}.spaaza-receipt .receipt-original-price{display:none}.spaaza-receipt .receipt-original-price.receipt-line-through{display:inline}.spaaza-receipt .btn-download{width:100%;padding-bottom:15px;background-color:#348eda;border-radius:5px;text-align:center;font-family:"Helvetica Neue",Helvetica,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;height:100%!important;line-height:1.6em;margin:0;padding:0;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}.spaaza-receipt .btn-download a{background-color:#348eda;border:solid 1px #348eda;border-radius:5px;color:#fff;cursor:pointer;display:inline-block;font-size:14px;font-weight:700;margin:0;padding:12px 25px;text-decoration:none;text-transform:capitalize}.spaaza-receipt .receipt-footer-message{text-align:center}.spaaza-receipt .barcode{padding:2em 0}.spaaza-receipt .barcode .image{background-position:center top;background-repeat:no-repeat;height:45px}</style>\n<div class="spaaza-receipt">${contents}</div>`}}return customElements.define("spaaza-receipt",Receipt),Receipt});
